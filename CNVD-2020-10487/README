一.  漏洞概述
2月20日，国家信息安全漏洞共享平台（CNVD）发布了Apache Tomcat文件包含漏洞（CNVD-2020-10487/CVE-2020-1938）。该漏洞是由于Tomcat AJP协议存在缺陷而导致，攻击者利用该漏洞可通过构造特定参数，读取服务器webapp下的任意文件。若目标服务器同时存在文件上传功能，攻击者可进一步实现远程代码执行。目前，厂商已发布新版本完成漏洞修复。

Tomcat是Apache软件基金会中的一个重要项目，性能稳定且免费，是目前较为流行的Web应用服务器。由于Tomcat应用范围较广，因此本次通告的漏洞影响范围较大，请相关用户及时采取防护措施修复此漏洞。

参考链接：

https://www.cnvd.org.cn/webinfo/show/5415

受影响版本

Apache Tomcat 6
Apache Tomcat 7 < 7.0.100
Apache Tomcat 8 < 8.5.51
Apache Tomcat 9 < 9.0.31
不受影响版本

Apache Tomcat = 7.0.100
Apache Tomcat = 8.5.51
Apache Tomcat = 9.0.31


二. 漏洞原理

Apache Tomcat服务器通过Connector连接器组件与客户程序建立连接，被分别过配置了两个Connector：HTTP和AJP，我们通常使用HTTP Connector，也就是8080端口来访问Tomcat，它的配置文件在conf/serve.xml，它的配置如下：

<Connector port="8080" protocol="HTTP/1.1"
           connectionTimeout="20000"
           redirectPort="8443" />

AJP协议（Apache Jserv Protocol）使用8009端口，它能够优化HTTP请求，多用于集群，反向代理的场景，它的配置如下：

<Connector port="8009" protocol="AJP/1.3" redirectPort="8443" />

漏洞因为Tomcat AJP协议存在缺陷而产生，攻击者可通过该漏洞读取配置文件以及执行恶意代码。


三. 漏洞复现
环境：这里使用JDK1.8 ，tomcat版本为7.0.47
本次漏洞利用的是AJP协议，该协议工作在8009端口，查看本机已开启：
！[](https://github.com/TLLONE/Vulnerability-emersion/blob/master/img/1d52a230577f535f6667ecb2b1b1fbe.png)
目前GitHub上已经有很多POC，自行下载脚本进行测试
现在利用该漏洞去读取WEB-INF/web.xml文件：

！[](https://github.com/TLLONE/Vulnerability-emersion/blob/master/img/65df4fe29c86ac581756e953dbc9b03.png)

批量检测Poc地址如下：
https://github.com/Kit4y/CNVD-2020-10487-Tomcat-Ajp-lfi-Scanner

四. 修复建议
目前，Apache官方已发布9.0.31、8.5.51及7.0.100版本对此漏洞进行修复，CNVD建议用户尽快升级新版本或采取临时缓解措施：

1. 如未使用Tomcat AJP协议：
如未使用 Tomcat AJP 协议，可以直接将 Tomcat 升级到 9.0.31、8.5.51或 7.0.100 版本进行漏洞修复。
如无法立即进行版本更新、或者是更老版本的用户，建议直接关闭AJPConnector，或将其监听地址改为仅监听本机localhost。

2、如果使用了Tomcat AJP协议：
建议将Tomcat立即升级到9.0.31、8.5.51或7.0.100版本进行修复，同时为AJP Connector配置secret来设置AJP协议的认证凭证。例如（注意必须将YOUR_TOMCAT_AJP_SECRET更改为一个安全性高、无法被轻易猜解的值）：
<Connector port="8009"protocol=“AJP/1.3” redirectPort="8443"address="YOUR_TOMCAT_IP_ADDRESS"requiredSecret=“YOUR_TOMCAT_AJP_SECRET” />
